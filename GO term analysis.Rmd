---
title: "GO term analysis"
output: html_document
date: "2024-10-31"
---

```{r}
# Load necessary libraries
library(clusterProfiler)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(patchwork)
library(GO.db)
library(here)
library(readr)

here::i_am("README.md")

# Define the path to the annotation file generated by BioBox. This is kegg pathways to GO terms
annotation_file <- here("Data", "kegg_to_GO.txt")
annotation_df <- read.delim(annotation_file, header = TRUE, sep = "\t", stringsAsFactors = FALSE)

# View the first few rows
head(annotation_df)

```

```{r}
# Function to clean and split entries
clean_split <- function(x) {
  x <- str_remove_all(x, ";$")       # Remove trailing semicolon
  x <- str_split(x, ";\\s*")[[1]]    # Split by semicolon and possible space
  x <- str_trim(x)                    # Trim whitespace
  return(x)
}

```

```{r}
# Reprocess annotation_clean to remove prefixes after separating rows
annotation_clean <- annotation_df %>%
  # Separate multiple GO IDs and Descriptions into individual rows first
  separate_rows(GO_ID, GO_Description, sep = ";\\s*") %>%
  # Remove prefixes from GO_ID and GO_Description
  mutate(
    GO_ID_clean = str_replace_all(GO_ID, "^[PFC]:", ""),                # Remove 'P:', 'F:', 'C:' from GO_ID
    GO_Description_clean = str_replace_all(GO_Description, "^[PFC]:", "")  # Remove 'P:', 'F:', 'C:' from GO_Description
  ) %>%
  # Separate multiple KEGG gene IDs into individual rows
  separate_rows(KEGG, sep = ";\\s*") %>%
  # Clean Gene IDs by removing 'ppa:' prefix and trimming whitespace
  mutate(
    Gene_clean = str_replace_all(KEGG, "^ppa:", ""),  # Remove 'ppa:' prefix from gene IDs
    Gene_clean = str_trim(Gene_clean)                  # Trim any leading/trailing whitespace
  ) %>%
  # Remove any empty strings resulting from separation
  filter(GO_ID_clean != "", GO_Description_clean != "", Gene_clean != "")

```


```{r}
# Create TERM2NAME dataframe without prefixes
TERM2NAME <- annotation_clean %>%
  dplyr::select(TERM = GO_ID_clean, Description = GO_Description_clean) %>%  # Specify dplyr::select()
  distinct()  # Remove duplicate GO ID-Description pairs

# View the TERM2NAME dataframe
head(TERM2NAME)

# Create TERM2GENE dataframe
TERM2GENE <- annotation_clean %>%
  dplyr::select(TERM = GO_ID_clean, GENE = Gene_clean) %>%  # Specify dplyr::select()
  distinct()

# View the TERM2GENE dataframe
head(TERM2GENE)
```
```{r}
# Define the path to your CSV file (which is in the project root)
data_path_24 <- here("significant_proteins_glycerol_feeding_methanol_24.csv")
deproteins_glycerol_feeding_m24 <- read.csv(data_path_24, header = TRUE, stringsAsFactors = FALSE)

# Define the path for glycerol resting
data_path_glycerol_resting <- here("significant_proteins_glycerol_resting.csv")
deproteins_glycerol_feeding_resting <- read.csv(data_path_glycerol_resting, header = TRUE, stringsAsFactors = FALSE)

# Define the path for methanol feeding at 48 hours
data_path_glycerol_feeding_m48 <- here("significant_proteins_methanol_48_hours.csv")
deproteins_glycerol_feeding_m48 <- read.csv(data_path_glycerol_feeding_m48, header = TRUE, stringsAsFactors = FALSE)

# Define the path for methanol feeding at 72 hours
data_path_glycerol_feeding_m72 <- here("significant_proteins_methanol_72_hours.csv")
deproteins_glycerol_feeding_m72 <- read.csv(data_path_glycerol_feeding_m72, header = TRUE, stringsAsFactors = FALSE)
```

```{r}
# Upload background proteins
bgproteins_data_path <- here("Data", "background_genes.csv")

# Read the CSV file into a data frame
bgproteins_data <- read.csv(bgproteins_data_path, header = TRUE, stringsAsFactors = FALSE)

# Extract unique proteins
bgproteins <- unique(bgproteins_data$Protein)
```



```{r}
# Remove 'ppa:' prefix from bgproteins
bgproteins_clean <- str_replace_all(bgproteins, "^ppa:", "")

# Update bgproteins with the cleaned version
bgproteins <- bgproteins_clean

# Verify the cleaning
head(bgproteins)
```


```{r}

# More abundant proteins (assuming logFC > 0)
up_proteins_24 <- deproteins_glycerol_feeding_m24[deproteins_glycerol_feeding_m24$logFC > 0, ]

# Down-regulated proteins (assuming logFC < 0)
down_proteins_24 <- deproteins_glycerol_feeding_m24[deproteins_glycerol_feeding_m24$logFC < 0, ]

# --- For Glycerol Resting ---
# More abundant proteins (assuming logFC > 0)
up_proteins_resting <- deproteins_glycerol_feeding_resting[deproteins_glycerol_feeding_resting$logFC > 0, ]

# Down-regulated proteins (assuming logFC < 0)
down_proteins_resting <- deproteins_glycerol_feeding_resting[deproteins_glycerol_feeding_resting$logFC < 0, ]

# --- For Glycerol Feeding at 48 Hours ---
# More abundant proteins (assuming logFC > 0)
up_proteins_m48 <- deproteins_glycerol_feeding_m48[deproteins_glycerol_feeding_m48$logFC > 0, ]

# Down-regulated proteins (assuming logFC < 0)
down_proteins_m48 <- deproteins_glycerol_feeding_m48[deproteins_glycerol_feeding_m48$logFC < 0, ]

# --- For Glycerol Feeding at 72 Hours ---
# More abundant proteins (assuming logFC > 0)
up_proteins_m72 <- deproteins_glycerol_feeding_m72[deproteins_glycerol_feeding_m72$logFC > 0, ]

# Down-regulated proteins (assuming logFC < 0)
down_proteins_m72 <- deproteins_glycerol_feeding_m72[deproteins_glycerol_feeding_m72$logFC < 0, ]

```

```{r}
# Select necessary columns and rename
up_proteins_clean_24 <- up_proteins_24[, c('Protein', 'logFC')]
colnames(up_proteins_clean_24) <- c('GeneID', 'FoldChange')

down_proteins_clean_24 <- down_proteins_24[, c('Protein', 'logFC')]
colnames(down_proteins_clean_24) <- c('GeneID', 'FoldChange')

# --- For Glycerol Resting ---
# Select necessary columns and rename
up_proteins_clean_resting <- up_proteins_resting[, c('Protein', 'logFC')]
colnames(up_proteins_clean_resting) <- c('GeneID', 'FoldChange')

down_proteins_clean_resting <- down_proteins_resting[, c('Protein', 'logFC')]
colnames(down_proteins_clean_resting) <- c('GeneID', 'FoldChange')

# --- For Glycerol Feeding at 48 Hours ---
# Select necessary columns and rename
up_proteins_clean_m48 <- up_proteins_m48[, c('Protein', 'logFC')]
colnames(up_proteins_clean_m48) <- c('GeneID', 'FoldChange')

down_proteins_clean_m48 <- down_proteins_m48[, c('Protein', 'logFC')]
colnames(down_proteins_clean_m48) <- c('GeneID', 'FoldChange')


# --- For Glycerol Feeding at 72 Hours ---
# Select necessary columns and rename
up_proteins_clean_m72 <- up_proteins_m72[, c('Protein', 'logFC')]
colnames(up_proteins_clean_m72) <- c('GeneID', 'FoldChange')

down_proteins_clean_m72 <- down_proteins_m72[, c('Protein', 'logFC')]
colnames(down_proteins_clean_m72) <- c('GeneID', 'FoldChange')
```


```{r}
# Extract gene lists as character vectors
up_genes_24 <- as.character(up_proteins_clean_24$GeneID)
down_genes_24 <- as.character(down_proteins_clean_24$GeneID)

# --- For Glycerol Resting ---
# Extract gene lists as character vectors
up_genes_resting <- as.character(up_proteins_clean_resting$GeneID)
down_genes_resting <- as.character(down_proteins_clean_resting$GeneID)

# --- For Glycerol Feeding at 48 Hours ---
# Extract gene lists as character vectors
up_genes_m48 <- as.character(up_proteins_clean_m48$GeneID)
down_genes_m48 <- as.character(down_proteins_clean_m48$GeneID)

# --- For Glycerol Feeding at 72 Hours ---
# Extract gene lists as character vectors
up_genes_m72 <- as.character(up_proteins_clean_m72$GeneID)
down_genes_m72 <- as.character(down_proteins_clean_m72$GeneID)
```


```{r}
# Function to remove 'ppa:' prefix from gene IDs
clean_gene_ids <- function(gene_list) {
  cleaned_genes <- str_replace_all(gene_list, "^ppa:", "")
  return(cleaned_genes)
}

# Apply the function to all your gene lists
up_genes_24_clean <- clean_gene_ids(up_genes_24)
down_genes_24_clean <- clean_gene_ids(down_genes_24)

up_genes_resting_clean <- clean_gene_ids(up_genes_resting)
down_genes_resting_clean <- clean_gene_ids(down_genes_resting)

up_genes_m48_clean <- clean_gene_ids(up_genes_m48)
down_genes_m48_clean <- clean_gene_ids(down_genes_m48)

up_genes_m72_clean <- clean_gene_ids(up_genes_m72)
down_genes_m72_clean <- clean_gene_ids(down_genes_m72)
```

```{r}
# Perform GO enrichment for more abundant proteins
ego_up_24 <- enricher(gene = up_genes_24_clean,
                   TERM2GENE = TERM2GENE,
                   TERM2NAME = TERM2NAME,
                   universe = bgproteins,    # Background genes
                   pAdjustMethod = "BH",
                   pvalueCutoff = 0.05,
                   qvalueCutoff = 0.2)

# Perform GO enrichment for less abundant proteins  
ego_down_24 <- enricher(gene = down_genes_24_clean,
                     TERM2GENE = TERM2GENE,
                     TERM2NAME = TERM2NAME,
                     universe = bgproteins,    # Background genes
                     pAdjustMethod = "BH",
                     pvalueCutoff = 0.05,
                     qvalueCutoff = 0.2)

# --- For Glycerol Resting ---
# Perform GO enrichment for more abundant proteins
ego_up_resting <- enricher(gene = up_genes_resting_clean,
                            TERM2GENE = TERM2GENE, 
                            TERM2NAME = TERM2NAME,
                            universe = bgproteins,    # Background genes
                            pAdjustMethod = "BH",
                            pvalueCutoff = 0.05,
                            qvalueCutoff = 0.2)

# Perform GO enrichment for less abundant proteins 
ego_down_resting <- enricher(gene = down_genes_resting_clean,
                              TERM2GENE = TERM2GENE,
                              TERM2NAME = TERM2NAME,
                              universe = bgproteins,    # Background genes
                              pAdjustMethod = "BH",
                              pvalueCutoff = 0.05,
                              qvalueCutoff = 0.2)


# --- For Glycerol Feeding at 48 Hours ---
# Perform GO enrichment for more abundant proteins
ego_up_m48 <- enricher(gene = up_genes_m48_clean,
                       TERM2GENE = TERM2GENE,
                       TERM2NAME = TERM2NAME,
                       universe = bgproteins,    # Background genes
                       pAdjustMethod = "BH",
                       pvalueCutoff = 0.05,
                       qvalueCutoff = 0.2)

# Perform GO enrichment for less abundant proteins 
ego_down_m48 <- enricher(gene = down_genes_m48_clean,
                         TERM2GENE = TERM2GENE,
                         TERM2NAME = TERM2NAME,
                         universe = bgproteins,    # Background genes
                         pAdjustMethod = "BH",
                         pvalueCutoff = 0.05,
                         qvalueCutoff = 0.2)


# --- For Glycerol Feeding at 72 Hours ---
# Perform GO enrichment for more abundant proteins
ego_up_m72 <- enricher(gene = up_genes_m72_clean,
                       TERM2GENE = TERM2GENE,
                       TERM2NAME = TERM2NAME,
                       universe = bgproteins,    # Background genes
                       pAdjustMethod = "BH",
                       pvalueCutoff = 0.05,
                       qvalueCutoff = 0.2)

# Perform GO enrichment for less abundant proteins 
ego_down_m72 <- enricher(gene = down_genes_m72_clean,
                         TERM2GENE = TERM2GENE,
                         TERM2NAME = TERM2NAME,
                         universe = bgproteins,    # Background genes
                         pAdjustMethod = "BH",
                         pvalueCutoff = 0.05,
                         qvalueCutoff = 0.2)
```

```{r}
# Function to extract enrichment results and add condition
extract_enrichment <- function(enrich_result, condition) {
  if (is.null(enrich_result) || nrow(enrich_result@result) == 0) {
    return(NULL)
  }
  
  enrich_df <- as.data.frame(enrich_result)
  
  # Check if Description exists; if not, map GO IDs to Descriptions
  if (!"Description" %in% colnames(enrich_df)) {
    go_ids <- enrich_df$ID
    enrich_df$Description <- Term(go_ids)
  }
  
  enrich_df$Condition <- condition
  return(enrich_df)
}

# Function to clean and select relevant columns
clean_enrichment <- function(enrich_combined) {
  if (is.null(enrich_combined) || nrow(enrich_combined) == 0) {
    return(NULL)
  }
  
  cleaned_df <- enrich_combined %>%
    dplyr::select(ID, Description, GeneRatio, p.adjust, Condition) %>%  # Specify dplyr::select()
    # Convert GeneRatio from string to numeric
    mutate(GeneRatio = as.numeric(str_split(GeneRatio, "/", simplify = TRUE)[,1]) / 
             as.numeric(str_split(GeneRatio, "/", simplify = TRUE)[,2])) %>%
    # Optional: Filter for top N GO terms per condition
    group_by(Condition) %>%
    top_n(-10, p.adjust) %>%  # Select top 10 GO terms with lowest p.adjust per condition
    ungroup()
  
  return(cleaned_df)
}


# Extract enrichment results for more abundant proteins
ego_up_24_df <- extract_enrichment(ego_up_24, "24h")
ego_up_m48_df <- extract_enrichment(ego_up_m48, "48h")
ego_up_m72_df <- extract_enrichment(ego_up_m72, "72h")

# Combine all more abundant proteins Enrichment Dataframes
ego_up_combined <- bind_rows(ego_up_24_df, ego_up_m48_df, ego_up_m72_df)

# Clean more abundant proteins Enrichment Data
ego_up_clean <- clean_enrichment(ego_up_combined)

# Extract enrichment results for less abundant proteins 
ego_down_24_df <- extract_enrichment(ego_down_24, "24h")
ego_down_m48_df <- extract_enrichment(ego_down_m48, "48h")
ego_down_m72_df <- extract_enrichment(ego_down_m72, "72h")

# Combine all Down-Regulated Enrichment Dataframes
ego_down_combined <- bind_rows(ego_down_24_df, ego_down_m48_df, ego_down_m72_df)

# Clean Down-Regulated Enrichment Data
ego_down_clean <- clean_enrichment(ego_down_combined)
```

```{r}
# Define a common theme for consistent legend positioning
common_theme <- theme(
  axis.text.y = element_text(size = 10, face = "bold"),
  axis.text.x = element_text(size = 10, face = "bold"),
  plot.title = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  legend.position = "right",            # Set legend position
  legend.title = element_text(size = 10, face = "bold"),
  legend.text = element_text(size = 9)
)
```


```{r}
# Plot for more abundant proteins
p_sample_up <- ggplot(ego_up_clean, aes(x = Condition, y = reorder(Description, GeneRatio))) +
  geom_point(aes(size = GeneRatio, color = p.adjust)) +
  scale_color_viridis_c(
    option = "plasma", 
    name = "log10 adjusted p-value", 
    trans = "log10",
    na.value = "grey50"
  ) +
  scale_size(range = c(3, 10), name = "Gene Ratio") +
  scale_x_discrete(
    labels = c(
      "24h" = "Methanol\n24 hours", 
      "48h" = "Methanol\n48 hours", 
      "72h" = "Methanol\n72 hours"
    )
  ) +
  theme_bw() +
  labs(title = "") +
  common_theme  # Apply the common theme

# Display the more abundnat proteins plot
print(p_sample_up)
```

```{r}
# Plot for less abundant proteins
p_sample_down <- ggplot(ego_down_clean, aes(x = Condition, y = reorder(Description, GeneRatio))) +
  geom_point(aes(size = GeneRatio, color = p.adjust)) +
  scale_color_viridis_c(
    option = "plasma", 
    name = "log10 adjusted p-value", 
    trans = "log10",
    na.value = "grey50"
  ) +
  scale_size(range = c(3, 10), name = "Gene Ratio") +
  scale_x_discrete(
    labels = c(
      "24h" = "Methanol\n24 hours", 
      "48h" = "Methanol\n48 hours", 
      "72h" = "Methanol\n72 hours"
    )
  ) +
  theme_bw() +
  labs(title = "") +
  common_theme  # Apply the same common theme

# Display the less abundant plot
print(p_sample_down)
```

